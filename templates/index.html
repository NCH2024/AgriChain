{% extends "base.html" %}

{% block title %}Trang chủ{% endblock %}

{% block banner %}
<div class="container-fluid py-5 position-relative overflow-hidden d-flex align-items-center" style="min-height: 600px;">
    
    <div id="heroCarousel" class="carousel slide carousel-fade position-absolute top-0 start-0 w-100 h-100" 
         data-bs-ride="carousel" data-bs-interval="4000" style="z-index: 0; opacity: 0.3;">
        <div class="carousel-inner h-100">
    
            {% if slideshow_images %}
                
                {% for img_name in slideshow_images %}
                <div class="carousel-item h-100 {% if loop.first %}active{% endif %}">
                    <img src="{{ url_for('static', filename='slideshow/' + img_name) }}" 
                        class="d-block w-100 h-100 object-fit-cover"
                        alt="Slide {{ loop.index }}">
                </div>
                {% endfor %}

            {% else %}
                
                <div class="carousel-item active h-100">
                    <img src="https://images.unsplash.com/photo-1625246333195-031200956307?auto=format&fit=crop&w=1920&q=80" 
                        class="d-block w-100 h-100 object-fit-cover">
                </div>

            {% endif %}

        </div>
    </div>

    <div class="container text-center position-relative" style="z-index: 2;">
        <span class="badge bg-white border border-secondary text-lemon navbar-glass shadow-sm px-3 py-2 mb-3 rounded-pill animate__animated animate__fadeInDown">
            Nền tảng truy xuất nguồn gốc 4.0
        </span>
        
        <h1 class="display-3 fw-bold mb-3 animate__animated animate__fadeInUp ">
            Nông Sản Sạch <br>
            <span class="text-lemon" style="background: linear-gradient(120deg, var(--primary-color), var(--accent-color)); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">
                Minh Bạch Trên Blockchain
            </span>
        </h1>
        
        <p class="lead text-dark mb-5 mx-auto animate__animated animate__fadeInUp animate__delay-1s fw-medium" style="max-width: 700px;">
            Mỗi sản phẩm là một câu chuyện. Hãy quét mã để kiểm chứng hành trình từ nông trại đến bàn ăn với độ tin cậy tuyệt đối.
        </p>
        
        <div class="row justify-content-center animate__animated animate__fadeInUp animate__delay-1s">
            <div class="col-md-8 col-lg-6">
                <form method="POST" action="/" class="glass-box p-2 d-flex align-items-center shadow-lg" style="border-radius: 50px; padding: 10px !important; background: rgba(255,255,255,0.95);">
                    <i class="fas fa-search text-muted ms-3 fs-5"></i>
                    <input type="text" name="search_code" class="form-control border-0 bg-transparent shadow-none" 
                           placeholder="Nhập mã lô hàng (VD: RAU_001)..." 
                           style="font-size: 1.1rem; height: 50px;">
                    <button type="submit" class="btn btn-lemon rounded-pill px-4 py-2 ms-2">
                        Tra Cứu
                    </button>
                </form>
                <div class="mt-3 text-dark small">
                    <i class="fas fa-info-circle me-1"></i> Thử các mã: <span class="fw-bold cursor-pointer">RAU_001</span>, <span class="fw-bold">GAO_ST25</span>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
    {% block marquee %}
<div class="marquee-wrapper border-top border-bottom border-light border-opacity-10">
    <div class="marquee-content">
        <span>AGRICHAIN</span>
        <span>AGRICHAIN</span>
        <span>AGRICHAIN</span>
        <span>AGRICHAIN</span>
        <span>AGRICHAIN</span>
        <span>AGRICHAIN</span>
        <span>AGRICHAIN</span>
        <span>AGRICHAIN</span>
    </div>
    
    <div class="marquee-content">
        <span>AGRICHAIN</span>
        <span>AGRICHAIN</span>
        <span>AGRICHAIN</span>
        <span>AGRICHAIN</span>
        <span>AGRICHAIN</span>
        <span>AGRICHAIN</span>
        <span>AGRICHAIN</span>
        <span>AGRICHAIN</span>
    </div>
</div>
{% endblock %}
{% block content %}
<div class="container pb-5">
    
    {% if ket_qua %}
    <div class="glass-box mb-5 border-success" style="border-left: 5px solid var(--accent-color);">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h4 class="text-lemon mb-0"><i class="fas fa-check-circle me-2"></i>Kết quả tìm kiếm</h4>
            <span class="badge bg-light text-dark border">Found {{ ket_qua|length }} records</span>
        </div>
        
        <div class="table-responsive">
            <table class="table mb-0 align-middle">
                <thead class="bg-light">
                    <tr>
                        <th class="ps-3">Mã Lô</th>
                        <th>Hình ảnh</th>
                        <th>Loại SP</th>
                        <th>Hành động</th>
                        <th>Thời gian</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in ket_qua %}
                    <tr>
                        <td class="fw-bold ps-3 text-primary">{{ item.batch_code }}</td>
                        <td>
                            {% if item.image_id %}
                                <img src="/image/{{ item.image_id }}" class="shadow-sm border" style="width: 48px; height: 48px; border-radius: 10px; object-fit: cover;">
                            {% else %}
                                <div class="bg-light rounded-3 d-flex align-items-center justify-content-center text-muted border" style="width: 48px; height: 48px;">
                                    <i class="fas fa-image"></i>
                                </div>
                            {% endif %}
                        </td>
                        <td class="fw-bold">{{ item.product_type }}</td>
                        <td><span class="badge bg-light text-dark border">{{ item.action }}</span></td>
                        <td class="small text-muted">{{ item.timestamp_fmt }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}

    <div class="d-flex justify-content-between align-items-end mb-4 mt-5">
        <div>
            <h6 class="text-lemon text-uppercase mb-1">Realtime Feed</h6>
            <h3 class="fw-bold mb-0">Lô hàng mới cập nhật</h3>
        </div>
        <a href="#" class="text-muted small text-decoration-none hover-primary">
            Cập nhật tự động <i class="fas fa-sync-alt ms-1 animate__animated animate__spin"></i>
        </a>
    </div>

    <div class="row g-4" id="product-list">
        {% for p in products %}
        <div class="col-md-6 col-lg-3 product-item {% if loop.index > 8 %}d-none{% endif %}">
            <div class="glass-box h-100 p-0 overflow-hidden group-hover-effect border-0 shadow-sm hover-shadow-lg transition-all">
                <div class="position-relative bg-light" style="height: 180px;">
                    {% if p.image_id %}
                        <img src="/image/{{ p.image_id }}" class="w-100 h-100 object-fit-cover transition-transform">
                    {% else %}
                        <img src="/static/image/blockchain.gif" class="opacity-25 w-50 object-fit-container position-absolute top-50 start-50 translate-middle">
                        
                    {% endif %}
                    
                    <span class="position-absolute top-0 start-0 m-3 badge bg-white text-dark shadow-sm border">
                        {{ p.batch_code }}
                    </span>
                    <span class="position-absolute bottom-0 end-0 m-3 badge bg-black shadow-sm" style="font-size: 0.7rem;">
                        {{ p.timestamp_fmt }}
                    </span>
                </div>
                
                <div class="p-4">
                    <h6 class="fw-bold text-dark mb-1 text-truncate">{{ p.product_type }}</h6>
                    <p class="text-lemon small mb-3 fw-bold">{{ p.action }}</p>
                    
                    <a href="/trace/{{ p.batch_code }}" class="btn btn-outline-lemon w-100 btn-sm rounded-pill">
                        Xem chi tiết
                    </a>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    {% if products|length > 8 %}
    <div class="text-center mt-5 d-flex justify-content-center gap-3" id="action-buttons">
        <button id="btn-load-more" class="btn btn-white border shadow-sm px-5 py-2 rounded-pill text-muted hover-primary transition-all">
            Xem thêm <i class="fas fa-chevron-down ms-2"></i>
        </button>
        
        <button id="btn-collapse" class="btn btn-lemon-outline border shadow-sm px-4 py-2 rounded-pill d-none animate__animated animate__fadeIn">
            <i class="fas fa-compress-arrows-alt me-2"></i>Thu nhỏ
        </button>
    </div>
    {% endif %}

    <div class="container py-5 mt-5">
        <div class="text-center mb-5 animate__animated animate__fadeInUp">
            <h6 class="text-lemon text-uppercase fw-bold letter-spacing-1">Quy trình AgriChain</h6>
            <h2 class="fw-bold text-dark display-6">Hành trình từ Nông trại đến Bàn ăn</h2>
            <p class="text-muted mx-auto" style="max-width: 600px;">
                Dữ liệu được ghi nhận theo thời gian thực và lưu trữ vĩnh viễn trên Blockchain, đảm bảo không ai có thể can thiệp sửa đổi.
            </p>
        </div>

        <div class="row g-4 position-relative">
            <div class="d-none d-lg-block position-absolute top-50 start-0 w-100 translate-middle-y border-top border-2 border-dashed border-success opacity-25" style="z-index: 0;"></div>

            <div class="col-lg-3 col-md-6 position-relative" style="z-index: 1;">
                <div class="glass-box bg-white text-center p-4 h-100 border-0 shadow-sm hover-scale group-hover-effect">
                    <div class="rounded-circle bg-lemon-light mx-auto mb-4 d-flex align-items-center justify-content-center" 
                        style="width: 80px; height: 80px; background: rgba(6, 95, 70, 0.1);">
                        <i class="fas fa-seedling fa-2x text-lemon"></i>
                    </div>
                    <h5 class="fw-bold">1. Canh Tác</h5>
                    <p class="small text-muted mb-0">Nông dân ghi nhật ký chăm sóc, bón phân, tưới tiêu. Dữ liệu được ký số xác thực.</p>
                </div>
            </div>

            <div class="col-lg-3 col-md-6 position-relative" style="z-index: 1;">
                <div class="glass-box bg-white text-center p-4 h-100 border-0 shadow-sm hover-scale group-hover-effect">
                    <div class="rounded-circle bg-lemon-light mx-auto mb-4 d-flex align-items-center justify-content-center" 
                        style="width: 80px; height: 80px; background: rgba(16, 185, 129, 0.1);">
                        <i class="fas fa-cubes fa-2x text-accent"></i>
                    </div>
                    <h5 class="fw-bold">2. Blockchain hoá</h5>
                    <p class="small text-muted mb-0">Thông tin thu hoạch được đóng gói thành các Block, mã hoá và đẩy lên chuỗi khối.</p>
                </div>
            </div>

            <div class="col-lg-3 col-md-6 position-relative" style="z-index: 1;">
                <div class="glass-box bg-white text-center p-4 h-100 border-0 shadow-sm hover-scale group-hover-effect">
                    <div class="rounded-circle bg-lemon-light mx-auto mb-4 d-flex align-items-center justify-content-center" 
                        style="width: 80px; height: 80px; background: rgba(245, 158, 11, 0.1);">
                        <i class="fas fa-truck-loading fa-2x text-warning"></i>
                    </div>
                    <h5 class="fw-bold">3. Phân Phối</h5>
                    <p class="small text-muted mb-0">Cập nhật trạng thái vận chuyển, kho bãi. Đảm bảo quy trình bảo quản đúng chuẩn.</p>
                </div>
            </div>

            <div class="col-lg-3 col-md-6 position-relative" style="z-index: 1;">
                <div class="glass-box bg-white text-center p-4 h-100 border-0 shadow-sm hover-scale group-hover-effect">
                    <div class="rounded-circle bg-lemon-light mx-auto mb-4 d-flex align-items-center justify-content-center" 
                        style="width: 80px; height: 80px; background: rgba(59, 130, 246, 0.1);">
                        <i class="fas fa-qrcode fa-2x text-primary"></i>
                    </div>
                    <h5 class="fw-bold">4. Truy Xuất</h5>
                    <p class="small text-muted mb-0">Người tiêu dùng quét QR Code để xem lại toàn bộ lịch sử minh bạch 100%.</p>
                </div>
            </div>
        </div>
    </div>

    <div class="mt-5 pt-5">
        <div class="glass-box p-0 overflow-hidden shadow-lg border-0">
            <div class="row g-0">
                <div class="col-lg-6 p-5 d-flex flex-column justify-content-center bg-white">
                    <span class="text-lemon fw-bold text-uppercase mb-2">Về AgriChain</span>
                    <h2 class="fw-bold mb-4 text-dark">Kết nối niềm tin nông nghiệp</h2>
                    <p class="text-muted mb-4">
                        Chúng tôi áp dụng công nghệ Blockchain tiên tiến nhất để số hoá toàn bộ quy trình canh tác. 
                        Dữ liệu được ghi nhận minh bạch, không thể sửa đổi, mang lại sự an tâm tuyệt đối cho người tiêu dùng.
                        Minh bạch trong cách thức logistics, truy xuất nguồn gốc dễ dàng chỉ với vài thao tác quét mã QR.
                        "Một lần tin tưởng, mãi mãi an tâm" - đó là cam kết của chúng tôi đối với khách hàng.
                    </p>
                    
                    <div class="d-flex gap-4 mt-2">
                        <div class="text-center">
                            <h4 class="fw-bold text-dark mb-0">100%</h4>
                            <small class="text-muted">Minh bạch</small>
                        </div>
                        <div class="text-center border-start ps-4">
                            <h4 class="fw-bold text-dark mb-0">24/7</h4>
                            <small class="text-muted">Truy xuất</small>
                        </div>
                        <div class="text-center border-start ps-4">
                            <h4 class="fw-bold text-dark mb-0">AI</h4>
                            <small class="text-muted">Giám sát</small>
                        </div>
                    </div>
                </div>

                <div class="col-lg-6 position-relative min-vh-50">
                    <img src="/static/image/intro.jpg" 
                         alt="Smart Farm" 
                         class="w-100 h-100 object-fit-cover absolute-full">
                    <div class="position-absolute top-0 start-0 w-100 h-100" style="background: rgba(6, 95, 70, 0.2);"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    /* CSS bổ trợ cục bộ cho hiệu ứng */
    .hover-shadow-lg:hover {
        transform: translateY(-5px);
        box-shadow: 0 20px 40px rgba(0,0,0,0.1) !important;
    }
    .transition-all { transition: all 0.3s ease; }
    .transition-transform { transition: transform 0.5s ease; }
    .group-hover-effect:hover .transition-transform { transform: scale(1.05); }
    .cursor-pointer { cursor: pointer; }
    
    /* Hiệu ứng mờ cho nút */
    .btn-lemon-outline {
        border: 2px solid var(--primary-color);
        color: var(--primary-color);
        background: transparent;
    }
    .btn-lemon-outline:hover {
        background: var(--primary-color);
        color: white;
    }
</style>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const btnLoadMore = document.getElementById('btn-load-more');
        const btnCollapse = document.getElementById('btn-collapse');
        const items = document.querySelectorAll('.product-item');
        const BATCH_SIZE = 4; // Mỗi lần hiện thêm 1 hàng (4 lô)
        const INITIAL_VISIBLE = 8; // Số lượng ban đầu

        if (btnLoadMore && btnCollapse) {
            
            // --- XỬ LÝ NÚT XEM THÊM ---
            btnLoadMore.addEventListener('click', function() {
                // Tìm các phần tử đang ẩn
                const hiddenItems = document.querySelectorAll('.product-item.d-none');
                
                // Hiện thêm BATCH_SIZE phần tử tiếp theo
                for (let i = 0; i < BATCH_SIZE && i < hiddenItems.length; i++) {
                    const item = hiddenItems[i];
                    item.classList.remove('d-none');
                    // Thêm hiệu ứng fade in cho mượt
                    item.style.opacity = 0;
                    setTimeout(() => item.style.opacity = 1, 50);
                    item.style.transition = 'opacity 0.5s';
                }

                // Kiểm tra xem còn phần tử ẩn nào không
                const remainingHidden = document.querySelectorAll('.product-item.d-none').length;
                if (remainingHidden === 0) {
                    // Nếu hết rồi thì ẩn nút Xem thêm đi
                    btnLoadMore.classList.add('d-none');
                }

                // Luôn hiện nút Thu nhỏ khi đã bấm Xem thêm
                btnCollapse.classList.remove('d-none');
            });

            // --- XỬ LÝ NÚT THU NHỎ ---
            btnCollapse.addEventListener('click', function() {
                // Duyệt qua tất cả items, ẩn đi những cái có index >= INITIAL_VISIBLE
                items.forEach((item, index) => {
                    if (index >= INITIAL_VISIBLE) {
                        item.classList.add('d-none');
                    }
                });

                // Reset trạng thái nút
                btnLoadMore.classList.remove('d-none'); // Hiện lại nút Xem thêm
                btnCollapse.classList.add('d-none');    // Ẩn nút Thu nhỏ đi
                
                // Cuộn nhẹ lên đầu danh sách để người dùng biết đã thu gọn
                document.getElementById('product-list').scrollIntoView({ behavior: 'smooth', block: 'start' });
            });
        }
    });
</script>
{% endblock %}