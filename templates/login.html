<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AgriChain - ÄÄƒng nháº­p</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">

  <div class="container py-5">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <a class="btn btn-outline-secondary" href="/">â† Quay láº¡i trang chá»§</a>
      <h3 class="m-0 text-success fw-bold">AgriChain</h3>
      <div style="width:160px"></div>
    </div>

    <div class="row justify-content-center">
      <div class="col-12 col-md-6">
        <div class="card shadow-sm">
          <div class="card-body">
            <h5 class="mb-3">ÄÄƒng nháº­p báº±ng MetaMask</h5>
            <div class="alert alert-info">
              Nháº¥n <b>ÄÄƒng nháº­p</b> Ä‘á»ƒ káº¿t ná»‘i MetaMask. Náº¿u vÃ­ chÆ°a Ä‘Äƒng kÃ½, há»‡ thá»‘ng sáº½ yÃªu cáº§u chá»n phÃ¢n quyá»n.
            </div>

            <button id="btnLogin" type="button" class="btn btn-success w-100">ğŸ¦Š ÄÄƒng nháº­p</button>

            <div id="roleBox" class="mt-3" style="display:none;">
              <label class="form-label fw-bold">Chá»n phÃ¢n quyá»n</label>
              <select id="roleSelect" class="form-select">
                <option value="farmer">NhÃ  nÃ´ng (farmer)</option>
                <option value="factory">NhÃ  mÃ¡y (factory)</option>
              </select>
              <button id="btnRegisterRole" type="button" class="btn btn-primary w-100 mt-2">XÃ¡c nháº­n Ä‘Äƒng kÃ½</button>
            </div>

            <div id="msg" class="text-danger small mt-3"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
async function fetchJSON(url, options){
  const r = await fetch(url, options);
  const data = await r.json().catch(()=> ({}));
  if(!r.ok) throw new Error(data.error || r.statusText || "Request failed");
  return data;
}

async function connectWallet(){
  if(!window.ethereum) throw new Error("ChÆ°a cÃ i MetaMask");
  const accounts = await window.ethereum.request({ method: "eth_requestAccounts" });
  return accounts[0];
}

async function getNonceMessage(){
  // Æ°u tiÃªn GET (Ä‘a sá»‘ project dÃ¹ng GET). Náº¿u server dÃ¹ng POST thÃ¬ fallback.
  try{
    return await fetchJSON("/api/nonce", { method: "GET" });
  }catch(e){
    return await fetchJSON("/api/nonce", { method: "POST" });
  }
}

async function signNonce(address){
  const nonceRes = await getNonceMessage();
  const message = nonceRes.message || nonceRes.nonce || nonceRes.text;
  if(!message) throw new Error("Server khÃ´ng tráº£ vá» nonce/message");
  const signature = await window.ethereum.request({
    method: "personal_sign",
    params: [message, address]
  });
  return { signature };
}

async function verify(address, signature){
  return await fetchJSON("/api/verify", {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({ address, signature })
  });
}

async function registerRole(role){
  return await fetchJSON("/api/register_role", {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({ role })
  });
}

const msgEl = document.getElementById("msg");
const roleBox = document.getElementById("roleBox");

document.getElementById("btnLogin").addEventListener("click", async () => {
  msgEl.textContent = "";
  try{
    const address = await connectWallet();
    const { signature } = await signNonce(address);
    const res = await verify(address, signature);

    if(res.need_register){
      roleBox.style.display = "block";
      msgEl.textContent = "VÃ­ chÆ°a Ä‘Äƒng kÃ½. HÃ£y chá»n phÃ¢n quyá»n rá»“i xÃ¡c nháº­n.";
      return;
    }
    window.location.href = "/dashboard";
  }catch(e){
    msgEl.textContent = e.message || String(e);
  }
});

document.getElementById("btnRegisterRole").addEventListener("click", async () => {
  msgEl.textContent = "";
  try{
    const role = document.getElementById("roleSelect").value;
    await registerRole(role);
    window.location.href = "/dashboard";
  }catch(e){
    msgEl.textContent = e.message || String(e);
  }
});
</script>

</body>
</html>
