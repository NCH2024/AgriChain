{% extends "base.html" %}

{% block title %}Đăng nhập hệ thống{% endblock %}

{% block content %}
<div class="container d-flex align-items-center justify-content-center" style="min-height: 70vh;">
    <div class="glass-box p-5 text-center shadow-lg animate__animated animate__zoomIn" style="max-width: 500px; width: 100%; border-top: 5px solid var(--primary-color);">
        
        <div class="mb-4">
            <div class="rounded-circle bg-light d-inline-flex align-items-center justify-content-center shadow-sm" style="width: 100px; height: 100px;">
                <img src="https://cdn-icons-png.flaticon.com/512/2058/2058288.png" width="60" alt="Wallet Icon">
            </div>
        </div>
        
        <h3 class="fw-bold mb-2 text-dark">Kết nối Ví Web3</h3>
        <p class="text-muted mb-4 small">
            Sử dụng MetaMask hoặc các ví tương thích để xác thực danh tính. <br>Hệ thống không lưu private key của bạn.
        </p>

        <div class="d-grid gap-3">
            <button id="btn-connect" class="btn btn-lemon btn-lg rounded-pill shadow-sm" onclick="connectWallet()">
                <img src="https://upload.wikimedia.org/wikipedia/commons/3/36/MetaMask_Fox.svg" width="24" class="me-2">
                Kết nối MetaMask
            </button>
            <div id="status" class="text-danger small fst-italic mt-2 fw-bold"></div>
        </div>
        
        <div class="mt-5 pt-3 border-top">
            <a href="/" class="text-muted small text-decoration-none fw-bold hover-primary">
                <i class="fas fa-arrow-left me-1"></i> Quay lại trang chủ
            </a>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
<script>
    async function connectWallet() {
        const status = document.getElementById("status");
        status.innerText = "Đang mở ví...";
        status.className = "text-primary small fst-italic mt-2 fw-bold";
        
        if (!window.ethereum) {
            status.innerText = "Lỗi: Chưa cài MetaMask!";
            status.className = "text-danger small fst-italic mt-2 fw-bold";
            return;
        }

        try {
            const provider = new ethers.providers.Web3Provider(window.ethereum);
            await provider.send("eth_requestAccounts", []);
            const signer = provider.getSigner();
            const address = await signer.getAddress();
            
            status.innerText = "Đang xác thực...";
            
            const res = await fetch("/api/login_wallet", {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({ wallet: address })
            });
            const data = await res.json();
            
            if (data.ok) {
                window.location.href = "/dashboard";
            } else {
                status.innerText = "Lỗi Server: " + data.error;
                status.className = "text-danger small fst-italic mt-2 fw-bold";
            }
        } catch (err) {
            console.error(err);
            status.innerText = "Đã huỷ kết nối.";
            status.className = "text-danger small fst-italic mt-2 fw-bold";
        }
    }
</script>
{% endblock %}