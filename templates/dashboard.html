<!DOCTYPE html>
<html lang="vi">
<head>
    
    <title>H·ªá th·ªëng Qu·∫£n l√Ω AgriChain</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <style>
        body { background-color: #f4f6f9; }
        .card { border: none; box-shadow: 0 0 15px rgba(0,0,0,0.05); }
        .nav-tabs .nav-link.active { color: #198754; font-weight: bold; border-top: 3px solid #198754; }
        .nav-tabs .nav-link { color: #555; }
        .status-badge { font-size: 0.85em; }

        /* --- PH·∫¶N M·ªöI: GIAO DI·ªÜN MOBILE --- */
        @media (max-width: 768px) {
            /* 1. ·∫®n ti√™u ƒë·ªÅ b·∫£ng ƒëi v√¨ tr√™n mobile kh√¥ng c·∫ßn */
            .table thead { display: none; }
            
            /* 2. Bi·∫øn m·ªói d√≤ng tr th√†nh m·ªôt c√°i th·∫ª (Card) */
            .table tr {
                display: block;
                margin-bottom: 15px;
                border: 1px solid #ddd;
                border-radius: 10px;
                background: #fff;
                box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            }
            
            /* 3. CƒÉn ch·ªânh t·ª´ng √¥ td */
            .table td {
                display: flex;
                justify-content: space-between;
                align-items: center;
                border-bottom: 1px solid #eee;
                padding: 10px 15px;
                text-align: right;
            }
            
            /* 4. Th√™m nh√£n (Label) ph√≠a tr∆∞·ªõc m·ªói th√¥ng tin ƒë·ªÉ d·ªÖ hi·ªÉu */
            .table td::before {
                content: attr(data-label); /* L·∫•y d·ªØ li·ªáu t·ª´ thu·ªôc t√≠nh data-label */
                font-weight: bold;
                color: #198754;
                text-align: left;
                margin-right: 15px;
            }

            /* 5. CƒÉn ch·ªânh l·∫°i n√∫t b·∫•m cho d·ªÖ ·∫•n */
            .btn-sm {
                width: 100%;
                margin-top: 5px;
                padding: 8px; /* N√∫t to h∆°n ch√∫t */
            }
            
            /* 6. Navbar g·ªçn l·∫°i */
            .navbar .ms-auto {
                margin-top: 10px;
                width: 100%;
                justify-content: space-between;
            }
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body>

    <nav class="navbar navbar-expand-lg navbar-dark bg-success px-4">
        <a class="navbar-brand fw-bold" href="#"><i class="fas fa-leaf"></i> AgriChain Manager</a>
        <div class="ms-auto d-flex align-items-center text-white">
            <span class="me-3">
               Xin ch√†o, <strong>{{ wallet }}</strong>
                <span class="badge bg-light text-success ms-1">{{ session.get('role') }}</span>
            </span>
            <a href="/products" class="btn btn-sm btn-outline-light me-2">üì¶ Danh s√°ch s·∫£n ph·∫©m</a>
            <a href="/logout" class="btn btn-sm btn-outline-light ms-3">ƒêƒÉng xu·∫•t</a>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <div class="row">
            
            <div class="col-lg-4 mb-4">
                <div class="card">
                    <div class="card-header bg-white">
                        <ul class="nav nav-tabs card-header-tabs" id="myTab" role="tablist">
                            
                            {% if session['role'] == 'farmer' %}
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="create-tab" data-bs-toggle="tab" data-bs-target="#create" type="button">üå± T·∫°o L√¥ M·ªõi</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="update-tab" data-bs-toggle="tab" data-bs-target="#update" type="button">üè≠ C·∫≠p Nh·∫≠t</button>
                            </li>
                            {% else %}
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="update-tab" data-bs-toggle="tab" data-bs-target="#update" type="button">üè≠ C·∫≠p Nh·∫≠t Quy Tr√¨nh</button>
                            </li>
                            {% endif %}
                            
                        </ul>
                    </div>
                    
                    <div class="card-body">
                        <div class="tab-content" id="myTabContent">
                            
                            {% if session['role'] == 'farmer' %}
                            <div class="tab-pane fade show active" id="create" role="tabpanel">
                                
                                <div class="alert alert-warning py-2 small">
                                    <i class="fas fa-exclamation-triangle"></i>
                                    L∆∞u √Ω: Giao d·ªãch Blockchain ƒë∆∞·ª£c k√Ω b·∫±ng MetaMask. File ·∫£nh ·ªü ƒë√¢y <b>kh√¥ng ƒë∆∞·ª£c g·ª≠i l√™n Blockchain</b>.
                                    N·∫øu b·∫°n mu·ªën l∆∞u ·∫£nh, h√£y upload l√™n server/IPFS ri√™ng r·ªìi l∆∞u URL v√†o ph·∫ßn Ghi ch√∫ chi ti·∫øt.
                                </div>
                                <form method="POST" action="/dashboard" enctype="multipart/form-data" onsubmit="return false;">
                                    <input type="hidden" name="mode" value="create">
                                    
                                    <div class="mb-3">
                                        <label class="form-label fw-bold">M√£ L√¥ H√†ng (Batch Code)</label>
                                        <input type="text" id="create_batch" name="batch_code" class="form-control" placeholder="VD: RAU_001" required>
                                        <div class="form-text">M√£ n√†y l√† duy nh·∫•t cho m·ªói ƒë·ª£t h√†ng.</div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label class="form-label fw-bold">T√™n N√¥ng S·∫£n</label>
                                        <input type="text" id="create_product" name="product_type" class="form-control" placeholder="VD: C·∫£i B·∫Øp H·ªØu C∆°" required>
                                    </div>

                                    <div class="mb-3">
                                        <label class="form-label fw-bold">H√†nh ƒë·ªông kh·ªüi t·∫°o</label>
                                        <input type="text" id="create_action" name="action" class="form-control" value="Gieo tr·ªìng / Kh·ªüi t·∫°o" required>
                                    </div>

                                    <div class="mb-3">
                                        <label class="form-label">Ghi ch√∫ chi ti·∫øt</label>
                                        <textarea id="create_details" name="details" class="form-control" rows="3"></textarea>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label class="form-label">Minh ch·ª©ng h√¨nh ·∫£nh</label>
                                        <input type="file" id="create_image" name="image_file" class="form-control" accept="image/*">
                                    </div>

                                    <button type="button" class="btn btn-success w-100" onclick="createBatch()"><i class="fas fa-plus-circle"></i> T·∫°o L√¥ H√†ng M·ªõi (MetaMask)</button>
                                </form>
                            </div>
                            {% endif %}

                            <div class="tab-pane fade {% if session['role'] != 'farmer' %}show active{% endif %}" id="update" role="tabpanel">
                                <div class="alert alert-info py-2 small">
                                    <i class="fas fa-info-circle"></i> Nh·∫≠p ƒë√∫ng <b>M√£ L√¥ H√†ng</b> c≈© ƒë·ªÉ n·ªëi ti·∫øp quy tr√¨nh.
                                </div>
                                <form method="POST" action="/dashboard" enctype="multipart/form-data" onsubmit="return false;">
                                    <input type="hidden" name="mode" value="update">

                                    <div class="mb-3">
                                        <label class="form-label fw-bold">Nh·∫≠p M√£ L√¥ H√†ng C·∫ßn C·∫≠p Nh·∫≠t</label>
                                        <input type="text" id="update_batch" name="batch_code" class="form-control" placeholder="VD: RAU_001" required>
                                    </div>

                                    <div class="mb-3">
                                        <label class="form-label fw-bold">T√™n N√¥ng S·∫£n (n·∫øu c·∫ßn)</label>
                                        <input type="text" id="update_product" name="product_type" class="form-control" placeholder="VD: C·∫£i B·∫Øp H·ªØu C∆° (c√≥ th·ªÉ ƒë·ªÉ tr·ªëng)">
                                        <div class="form-text">N·∫øu ƒë·ªÉ tr·ªëng, h·ªá th·ªëng s·∫Ω ghi "N/A" tr√™n Blockchain.</div>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label fw-bold">H√†nh ƒë·ªông ti·∫øp theo</label>
                                        <select id="update_action" name="action" class="form-select">
                                            {% if session['role'] == 'farmer' %}
                                                <option value="ChƒÉm s√≥c / T∆∞·ªõi n∆∞·ªõc">ChƒÉm s√≥c / T∆∞·ªõi n∆∞·ªõc</option>
                                                <option value="B√≥n ph√¢n">B√≥n ph√¢n</option>
                                                <option value="Phun thu·ªëc sinh h·ªçc">Phun thu·ªëc sinh h·ªçc</option>
                                                <option value="Thu ho·∫°ch">Thu ho·∫°ch</option>
                                                <option value="Chuy·ªÉn cho nh√† m√°y">Chuy·ªÉn cho nh√† m√°y</option>
                                            {% else %}
                                                <option value="Nh·∫≠p kho nguy√™n li·ªáu">Nh·∫≠p kho nguy√™n li·ªáu</option>
                                                <option value="S∆° ch·∫ø / R·ª≠a s·∫°ch">S∆° ch·∫ø / R·ª≠a s·∫°ch</option>
                                                <option value="ƒê√≥ng g√≥i bao b√¨">ƒê√≥ng g√≥i bao b√¨</option>
                                                <option value="D√°n tem truy xu·∫•t">D√°n tem truy xu·∫•t</option>
                                                <option value="V·∫≠n chuy·ªÉn si√™u th·ªã">V·∫≠n chuy·ªÉn si√™u th·ªã</option>
                                            {% endif %}
                                        </select>
                                    </div>

                                    <div class="mb-3">
                                        <label class="form-label">Chi ti·∫øt ho·∫°t ƒë·ªông</label>
                                        <textarea id="update_details" name="details" class="form-control" rows="3"></textarea>
                                    </div>

                                    <div class="mb-3">
                                        <label class="form-label">Minh ch·ª©ng h√¨nh ·∫£nh</label>
                                        <input type="file" id="update_image" name="image_file" class="form-control" accept="image/*">
                                    </div>

                                    <button type="button" class="btn btn-primary w-100" onclick="updateBatch()"><i class="fas fa-sync-alt"></i> C·∫≠p Nh·∫≠t Tr·∫°ng Th√°i (MetaMask)</button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-8">              
                <div class="row mb-4">
                    <div class="col-md-12">
                        <div class="card">
                            <div class="card-header bg-white fw-bold text-success">
                                <i class="fas fa-chart-pie"></i> Th·ªëng k√™ S·∫£n l∆∞·ª£ng
                            </div>
                            <div class="card-body">
                                <div style="height: 250px; width: 100%; display: flex; justify-content: center;">
                                    <canvas id="myChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header bg-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0 text-success"><i class="fas fa-list"></i> Danh s√°ch N√¥ng s·∫£n c·ªßa t√¥i</h5>
                        <button class="btn btn-sm btn-outline-secondary" onclick="location.reload()"><i class="fas fa-sync"></i> L√†m m·ªõi</button>

                        <button onclick="kiemTraHack()" class="btn btn-danger ms-2">
                            <i class="fas fa-shield-alt"></i> Ki·ªÉm tra An to√†n
                        </button>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover align-middle mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th>M√£ L√¥ (Batch ID)</th>
                                        <th>Lo·∫°i S·∫£n Ph·∫©m</th>
                                        <th>Tr·∫°ng Th√°i M·ªõi Nh·∫•t</th>
                                        <th>Th·ªùi gian</th>
                                        <th>H√†nh ƒë·ªông</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% if products %}
                                        {% for item in products %}
                                        <tr>
                                            <td data-label="M√£ L√¥:">
                                                <span class="badge bg-dark">{{ item.batch_code }}</span>
                                            </td>
                                            <td data-label="S·∫£n ph·∫©m:" class="fw-bold">
                                                {{ item.product_type }}
                                            </td>
                                            <td data-label="Tr·∫°ng th√°i:">
                                                <span class="badge bg-info text-dark status-badge">{{ item.action }}</span>
                                            </td>
                                            <td data-label="Th·ªùi gian:" class="small text-muted">
                                                {{ item.timestamp }}
                                            </td>
                                            <td data-label="Thao t√°c:">
                                                <div class="d-grid gap-2 d-md-block">
                                                    <form action="/" method="POST" target="_blank" style="display:inline;">
                                                        <input type="hidden" name="search_code" value="{{ item.batch_code }}">
                                                        <button type="submit" class="btn btn-sm btn-outline-primary">
                                                            <i class="fas fa-eye"></i> Xem
                                                        </button>
                                                    </form>
                                                    
                                                    <a href="/generate_qr/{{ item.batch_code }}" target="_blank" class="btn btn-sm btn-outline-dark">
                                                        <i class="fas fa-qrcode"></i> QR
                                                    </a>
                                                </div>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    {% else %}
                                        <tr>
                                            <td colspan="5" class="text-center py-4 text-muted">
                                                Ch∆∞a c√≥ d·ªØ li·ªáu. H√£y t·∫°o m·ªõi!
                                            </td>
                                        </tr>
                                    {% endif %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>


    <script>
        // L·∫•y d·ªØ li·ªáu t·ª´ Python truy·ªÅn sang (Server-side rendering)
        // L∆∞u √Ω: D√πng filter | tojson ƒë·ªÉ bi·∫øn list Python th√†nh m·∫£ng Javascript an to√†n
        const labels = {{ chart_labels | tojson }};
        const data = {{ chart_data | tojson }};

        // N·∫øu ch∆∞a c√≥ d·ªØ li·ªáu th√¨ kh√¥ng v·∫Ω ƒë·ªÉ tr√°nh l·ªói
        if (labels.length > 0) {
            const ctx = document.getElementById('myChart').getContext('2d');
            new Chart(ctx, {
                type: 'doughnut', // Lo·∫°i bi·ªÉu ƒë·ªì: 'pie' (tr√≤n), 'bar' (c·ªôt), 'doughnut' (b√°nh donut)
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'S·ªë l∆∞·ª£ng l√¥ h√†ng',
                        data: data,
                        backgroundColor: [
                            '#198754', // Xanh l√° c√¢y
                            '#ffc107', // V√†ng
                            '#0d6efd', // Xanh d∆∞∆°ng
                            '#dc3545', // ƒê·ªè
                            '#6c757d'  // X√°m
                        ],
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false, // ƒê·ªÉ n√≥ t·ª± co gi√£n theo khung div b√™n ngo√†i
                    plugins: {
                        legend: {
                            position: 'right', // Ch√∫ th√≠ch n·∫±m b√™n ph·∫£i cho ƒë·∫πp
                        }
                    }
                }
            });
        } else {
            document.getElementById('myChart').parentNode.innerHTML = "<p class='text-muted text-center pt-5'>Ch∆∞a c√≥ d·ªØ li·ªáu ƒë·ªÉ v·∫Ω bi·ªÉu ƒë·ªì.</p>";
        }
        async function kiemTraHack() {
            // Hi·ªán loading cho chuy√™n nghi·ªáp
            Swal.fire({
                title: 'ƒêang qu√©t Blockchain...',
                html: 'H·ªá th·ªëng ƒëang t√≠nh to√°n l·∫°i to√†n b·ªô m√£ Hash.',
                timerProgressBar: true,
                didOpen: () => {
                    Swal.showLoading();
                }
            });

            const response = await fetch('/validate_chain');
            const data = await response.json();
            
            // T·∫Øt loading
            Swal.close();

            if (data.status == "An to√†n") {
                // Th√¥ng b√°o ƒë·∫πp m√†u xanh
                Swal.fire({
                    icon: 'success',
                    title: 'H·ªá th·ªëng An to√†n!',
                    text: 'T·∫•t c·∫£ d·ªØ li·ªáu ƒë·ªÅu to√†n v·∫πn v√† kh·ªõp v·ªõi ch·ªØ k√Ω s·ªë.',
                    confirmButtonColor: '#198754'
                });
            } else {
                // C·∫¢NH B√ÅO ƒê·ªé + N√öT KH√îI PH·ª§C
                Swal.fire({
                    icon: 'error',
                    title: 'PH√ÅT HI·ªÜN T·∫§N C√îNG!',
                    html: `
                        D·ªØ li·ªáu t·∫°i <b>Block #${data.error_block}</b> ƒë√£ b·ªã thay ƒë·ªïi tr√°i ph√©p!<br>
                        M√£ Hash kh√¥ng tr√πng kh·ªõp.
                    `,
                    showCancelButton: true,
                    confirmButtonText: 'üõ†Ô∏è Kh√¥i ph·ª•c ngay',
                    cancelButtonText: 'B·ªè qua',
                    confirmButtonColor: '#d33',
                    cancelButtonColor: '#6c757d'
                }).then((result) => {
                    // N·∫øu ng∆∞·ªùi d√πng b·∫•m n√∫t Kh√¥i ph·ª•c
                    if (result.isConfirmed) {
                        khoiPhucBlock(data.error_block);
                    }
                });
            }
        }

        // H√ÄM G·ªåI API KH√îI PH·ª§C
        async function khoiPhucBlock(index) {
            const response = await fetch('/recover_chain', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ block_index: index })
            });
            const result = await response.json();

            if (result.status == 'success') {
                Swal.fire(
                    'ƒê√£ kh√¥i ph·ª•c!',
                    'D·ªØ li·ªáu g·ªëc ƒë√£ ƒë∆∞·ª£c l·∫•y l·∫°i t·ª´ Node Backup.',
                    'success'
                ).then(() => {
                    location.reload(); // T·∫£i l·∫°i trang ƒë·ªÉ th·∫•y d·ªØ li·ªáu ƒë√∫ng
                });
            } else {
                Swal.fire('L·ªói', 'Kh√¥ng th·ªÉ kh√¥i ph·ª•c.', 'error');
            }
        }
    </script>
    

    <script>
      // ====== MetaMask / Ethers: Ghi log l√™n Cronos Testnet ======
      // Y√™u c·∫ßu app.py render dashboard ph·∫£i truy·ªÅn: contract_abi=web3_connect.CONTRACT_ABI
      const CONTRACT_ADDRESS = "0x1228BC01B160D2da1932dc378C9c8689F002a9b7";
      const CONTRACT_ABI = {{ contract_abi | tojson }};
      const EXPLORER_TX = (h) => `https://explorer.cronos.org/testnet/tx/${h}`;

      async function getContractAndWallet() {
        if (!window.ethereum) {
          Swal.fire({icon:'error', title:'Thi·∫øu MetaMask', text:'B·∫°n ch∆∞a c√†i MetaMask ho·∫∑c tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£.'});
          throw new Error('No MetaMask');
        }
        const provider = new ethers.providers.Web3Provider(window.ethereum);
        await provider.send('eth_requestAccounts', []);
        const signer = provider.getSigner();
        const wallet = await signer.getAddress();
        const contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);
        return { wallet, contract };
      }

      
      async function uploadImageFromInput(inputId, batch_code, action, tx_hash) {
        const el = document.getElementById(inputId);
        if (!el || !el.files || el.files.length === 0) return null;

        const file = el.files[0];
        const fd = new FormData();
        fd.append("image", file);
        fd.append("batch_code", batch_code);
        fd.append("action", action || "");
        fd.append("tx_hash", tx_hash || "");

        const res = await fetch("/api/upload_image", { method: "POST", body: fd });
        const data = await res.json();
        if (!data.ok) {
          throw new Error(data.error || "Upload image failed");
        }
        return data.image_id;
      }

      async function getLatestProductType(batch_code) {
        const res = await fetch(`/api/batch_latest/${encodeURIComponent(batch_code)}`);
        const data = await res.json();
        if (!data.ok) return null;
        return data.product_type || null;
      }


async function saveTx(wallet, batch_code, tx_hash, action, image_id) {
        await fetch('/api/tx_record', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            wallet,
            batch_code,
            tx_hash,
            action,
            image_id: image_id || null,
            timestamp: Math.floor(Date.now()/1000)
          })
        });
      }

      function warnImageNotUploadedIfSelected(inputId) {
        const el = document.getElementById(inputId);
        if (el && el.files && el.files.length > 0) {
          Swal.fire({
            icon: 'info',
            title: 'L∆∞u √Ω v·ªÅ h√¨nh ·∫£nh',
            text: '·ªû phi√™n b·∫£n MetaMask, h√¨nh ·∫£nh KH√îNG ƒë∆∞·ª£c upload l√™n server v√¨ form kh√¥ng submit. N·∫øu b·∫°n mu·ªën l∆∞u ·∫£nh, c·∫ßn l√†m API upload ri√™ng (m√¨nh c√≥ th·ªÉ h∆∞·ªõng d·∫´n th√™m).'
          });
        }
      }

      async function createBatch() {
        try {
          const batch_code = document.getElementById('create_batch').value.trim();
          const product_type = document.getElementById('create_product').value.trim();
          const action = document.getElementById('create_action').value.trim();
          const details = document.getElementById('create_details').value.trim();

          if (!batch_code || !product_type || !action) {
            Swal.fire({icon:'warning', title:'Thi·∫øu d·ªØ li·ªáu', text:'Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß M√£ l√¥, T√™n n√¥ng s·∫£n v√† H√†nh ƒë·ªông.'});
            return;
          }

          warnImageNotUploadedIfSelected('create_image');

          const { wallet, contract } = await getContractAndWallet();

          Swal.fire({title:'ƒêang g·ª≠i giao d·ªãch...', html:'MetaMask s·∫Ω hi·ªán popup ƒë·ªÉ b·∫°n x√°c nh·∫≠n.', didOpen: () => Swal.showLoading()});
          const tx = await contract.themNhatKy(batch_code, product_type, action, details || '');
          Swal.fire({
            icon:'success',
            title:'ƒê√£ g·ª≠i giao d·ªãch!',
            html: `TX: <a target="_blank" href="${EXPLORER_TX(tx.hash)}">${tx.hash}</a>`
          });

          const image_id = await uploadImageFromInput('create_image', batch_code, action, tx.hash);
          await saveTx(wallet, batch_code, tx.hash, action, image_id);
          window.location.href = '/products';
        } catch (e) {
          console.error(e);
          Swal.fire({icon:'error', title:'L·ªói t·∫°o l√¥', text: e?.message || String(e)});
        }
      }

      async function updateBatch() {
        try {
          const batch_code = document.getElementById('update_batch').value.trim();
          const action = document.getElementById('update_action').value.trim();
          const details = document.getElementById('update_details').value.trim();
          const product_type_input = document.getElementById('update_product');
          let product_type = (product_type_input ? product_type_input.value.trim() : '');
          if (!product_type) {
            const latestType = await getLatestProductType(batch_code);
            if (!latestType) {
              Swal.fire({icon:'error', title:'M√£ l√¥ kh√¥ng t·ªìn t·∫°i', text:'Kh√¥ng t√¨m th·∫•y m√£ l√¥ tr√™n blockchain. H√£y nh·∫≠p ƒë√∫ng m√£ l√¥ ƒë√£ c√≥.'});
              return;
            }
            product_type = latestType;
          }

          if (!batch_code || !action) {
            Swal.fire({icon:'warning', title:'Thi·∫øu d·ªØ li·ªáu', text:'Vui l√≤ng nh·∫≠p M√£ l√¥ v√† ch·ªçn H√†nh ƒë·ªông.'});
            return;
          }

          warnImageNotUploadedIfSelected('update_image');

          const { wallet, contract } = await getContractAndWallet();

          Swal.fire({title:'ƒêang g·ª≠i giao d·ªãch...', html:'MetaMask s·∫Ω hi·ªán popup ƒë·ªÉ b·∫°n x√°c nh·∫≠n.', didOpen: () => Swal.showLoading()});
          const tx = await contract.themNhatKy(batch_code, product_type, action, details || '');

          Swal.fire({
            icon:'success',
            title:'ƒê√£ g·ª≠i giao d·ªãch c·∫≠p nh·∫≠t!',
            html: `TX: <a target="_blank" href="${EXPLORER_TX(tx.hash)}">${tx.hash}</a>`
          });

          const image_id = await uploadImageFromInput('create_image', batch_code, action, tx.hash);
          await saveTx(wallet, batch_code, tx.hash, action, image_id);
          window.location.href = '/products/' + encodeURIComponent(batch_code);
        } catch (e) {
          console.error(e);
          Swal.fire({icon:'error', title:'L·ªói c·∫≠p nh·∫≠t', text: e?.message || String(e)});
        }
      }
    </script>

</body>
</html>
