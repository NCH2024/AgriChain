<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>H·ªá th·ªëng Qu·∫£n l√Ω AgriChain</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { background-color: #f4f6f9; }
        .card { border: none; box-shadow: 0 0 15px rgba(0,0,0,0.05); }
        .nav-tabs .nav-link.active { color: #198754; font-weight: bold; border-top: 3px solid #198754; }
        .nav-tabs .nav-link { color: #555; }
        .status-badge { font-size: 0.85em; }

        /* --- PH·∫¶N M·ªöI: GIAO DI·ªÜN MOBILE --- */
        @media (max-width: 768px) {
            /* 1. ·∫®n ti√™u ƒë·ªÅ b·∫£ng ƒëi v√¨ tr√™n mobile kh√¥ng c·∫ßn */
            .table thead { display: none; }
            
            /* 2. Bi·∫øn m·ªói d√≤ng tr th√†nh m·ªôt c√°i th·∫ª (Card) */
            .table tr {
                display: block;
                margin-bottom: 15px;
                border: 1px solid #ddd;
                border-radius: 10px;
                background: #fff;
                box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            }
            
            /* 3. CƒÉn ch·ªânh t·ª´ng √¥ td */
            .table td {
                display: flex;
                justify-content: space-between;
                align-items: center;
                border-bottom: 1px solid #eee;
                padding: 10px 15px;
                text-align: right;
            }
            
            /* 4. Th√™m nh√£n (Label) ph√≠a tr∆∞·ªõc m·ªói th√¥ng tin ƒë·ªÉ d·ªÖ hi·ªÉu */
            .table td::before {
                content: attr(data-label); /* L·∫•y d·ªØ li·ªáu t·ª´ thu·ªôc t√≠nh data-label */
                font-weight: bold;
                color: #198754;
                text-align: left;
                margin-right: 15px;
            }

            /* 5. CƒÉn ch·ªânh l·∫°i n√∫t b·∫•m cho d·ªÖ ·∫•n */
            .btn-sm {
                width: 100%;
                margin-top: 5px;
                padding: 8px; /* N√∫t to h∆°n ch√∫t */
            }
            
            /* 6. Navbar g·ªçn l·∫°i */
            .navbar .ms-auto {
                margin-top: 10px;
                width: 100%;
                justify-content: space-between;
            }
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body>

    <nav class="navbar navbar-expand-lg navbar-dark bg-success px-4">
        <a class="navbar-brand fw-bold" href="#"><i class="fas fa-leaf"></i> AgriChain Manager</a>
        <div class="ms-auto d-flex align-items-center text-white">
            <span class="me-3">
                Xin ch√†o, <strong>{{ user }}</strong> 
                <span class="badge bg-light text-success ms-1">{{ session.get('role') }}</span>
            </span>
            <a href="/logout" class="btn btn-sm btn-outline-light">ƒêƒÉng xu·∫•t</a>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <div class="row">
            
            <div class="col-lg-4 mb-4">
                <div class="card">
                    <div class="card-header bg-white">
                        <ul class="nav nav-tabs card-header-tabs" id="myTab" role="tablist">
                            
                            {% if session['role'] == 'farmer' %}
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="create-tab" data-bs-toggle="tab" data-bs-target="#create" type="button">üå± T·∫°o L√¥ M·ªõi</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="update-tab" data-bs-toggle="tab" data-bs-target="#update" type="button">üè≠ C·∫≠p Nh·∫≠t</button>
                            </li>
                            {% else %}
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="update-tab" data-bs-toggle="tab" data-bs-target="#update" type="button">üè≠ C·∫≠p Nh·∫≠t Quy Tr√¨nh</button>
                            </li>
                            {% endif %}
                            
                        </ul>
                    </div>
                    
                    <div class="card-body">
                        <div class="tab-content" id="myTabContent">
                            
                            {% if session['role'] == 'farmer' %}
                            <div class="tab-pane fade show active" id="create" role="tabpanel">
                                <form method="POST" action="/dashboard" enctype="multipart/form-data">
                                    <input type="hidden" name="mode" value="create">
                                    
                                    <div class="mb-3">
                                        <label class="form-label fw-bold">M√£ L√¥ H√†ng (Batch Code)</label>
                                        <input type="text" name="batch_code" class="form-control" placeholder="VD: RAU_001" required>
                                        <div class="form-text">M√£ n√†y l√† duy nh·∫•t cho m·ªói ƒë·ª£t h√†ng.</div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label class="form-label fw-bold">T√™n N√¥ng S·∫£n</label>
                                        <input type="text" name="product_type" class="form-control" placeholder="VD: C·∫£i B·∫Øp H·ªØu C∆°" required>
                                    </div>

                                    <div class="mb-3">
                                        <label class="form-label fw-bold">H√†nh ƒë·ªông kh·ªüi t·∫°o</label>
                                        <input type="text" name="action" class="form-control" value="Gieo tr·ªìng / Kh·ªüi t·∫°o" required>
                                    </div>

                                    <div class="mb-3">
                                        <label class="form-label">Ghi ch√∫ chi ti·∫øt</label>
                                        <textarea name="details" class="form-control" rows="3"></textarea>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label class="form-label">Minh ch·ª©ng h√¨nh ·∫£nh</label>
                                        <input type="file" name="image_file" class="form-control" accept="image/*">
                                    </div>

                                    <button type="submit" class="btn btn-success w-100"><i class="fas fa-plus-circle"></i> T·∫°o L√¥ H√†ng M·ªõi</button>
                                </form>
                            </div>
                            {% endif %}

                            <div class="tab-pane fade {% if session['role'] != 'farmer' %}show active{% endif %}" id="update" role="tabpanel">
                                <div class="alert alert-info py-2 small">
                                    <i class="fas fa-info-circle"></i> Nh·∫≠p ƒë√∫ng <b>M√£ L√¥ H√†ng</b> c≈© ƒë·ªÉ n·ªëi ti·∫øp quy tr√¨nh.
                                </div>
                                <form method="POST" action="/dashboard" enctype="multipart/form-data">
                                    <input type="hidden" name="mode" value="update">

                                    <div class="mb-3">
                                        <label class="form-label fw-bold">Nh·∫≠p M√£ L√¥ H√†ng C·∫ßn C·∫≠p Nh·∫≠t</label>
                                        <input type="text" name="batch_code" class="form-control" placeholder="VD: RAU_001" required>
                                    </div>

                                    <div class="mb-3">
                                        <label class="form-label fw-bold">H√†nh ƒë·ªông ti·∫øp theo</label>
                                        <select name="action" class="form-select">
                                            {% if session['role'] == 'farmer' %}
                                                <option value="ChƒÉm s√≥c / T∆∞·ªõi n∆∞·ªõc">ChƒÉm s√≥c / T∆∞·ªõi n∆∞·ªõc</option>
                                                <option value="B√≥n ph√¢n">B√≥n ph√¢n</option>
                                                <option value="Phun thu·ªëc sinh h·ªçc">Phun thu·ªëc sinh h·ªçc</option>
                                                <option value="Thu ho·∫°ch">Thu ho·∫°ch</option>
                                                <option value="Chuy·ªÉn cho nh√† m√°y">Chuy·ªÉn cho nh√† m√°y</option>
                                            {% else %}
                                                <option value="Nh·∫≠p kho nguy√™n li·ªáu">Nh·∫≠p kho nguy√™n li·ªáu</option>
                                                <option value="S∆° ch·∫ø / R·ª≠a s·∫°ch">S∆° ch·∫ø / R·ª≠a s·∫°ch</option>
                                                <option value="ƒê√≥ng g√≥i bao b√¨">ƒê√≥ng g√≥i bao b√¨</option>
                                                <option value="D√°n tem truy xu·∫•t">D√°n tem truy xu·∫•t</option>
                                                <option value="V·∫≠n chuy·ªÉn si√™u th·ªã">V·∫≠n chuy·ªÉn si√™u th·ªã</option>
                                            {% endif %}
                                        </select>
                                    </div>

                                    <div class="mb-3">
                                        <label class="form-label">Chi ti·∫øt ho·∫°t ƒë·ªông</label>
                                        <textarea name="details" class="form-control" rows="3"></textarea>
                                    </div>

                                    <div class="mb-3">
                                        <label class="form-label">Minh ch·ª©ng h√¨nh ·∫£nh</label>
                                        <input type="file" name="image_file" class="form-control" accept="image/*">
                                    </div>

                                    <button type="submit" class="btn btn-primary w-100"><i class="fas fa-sync-alt"></i> C·∫≠p Nh·∫≠t Tr·∫°ng Th√°i</button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-8">              
                <div class="row mb-4">
                    <div class="col-md-12">
                        <div class="card">
                            <div class="card-header bg-white fw-bold text-success">
                                <i class="fas fa-chart-pie"></i> Th·ªëng k√™ S·∫£n l∆∞·ª£ng
                            </div>
                            <div class="card-body">
                                <div style="height: 250px; width: 100%; display: flex; justify-content: center;">
                                    <canvas id="myChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header bg-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0 text-success"><i class="fas fa-list"></i> Danh s√°ch N√¥ng s·∫£n c·ªßa t√¥i</h5>
                        <button class="btn btn-sm btn-outline-secondary" onclick="location.reload()"><i class="fas fa-sync"></i> L√†m m·ªõi</button>

                        <button onclick="kiemTraHack()" class="btn btn-danger ms-2">
                            <i class="fas fa-shield-alt"></i> Ki·ªÉm tra An to√†n
                        </button>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover align-middle mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th>M√£ L√¥ (Batch ID)</th>
                                        <th>Lo·∫°i S·∫£n Ph·∫©m</th>
                                        <th>Tr·∫°ng Th√°i M·ªõi Nh·∫•t</th>
                                        <th>Th·ªùi gian</th>
                                        <th>H√†nh ƒë·ªông</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% if products %}
                                        {% for item in products %}
                                        <tr>
                                            <td data-label="M√£ L√¥:">
                                                <span class="badge bg-dark">{{ item.batch_code }}</span>
                                            </td>
                                            <td data-label="S·∫£n ph·∫©m:" class="fw-bold">
                                                {{ item.product_type }}
                                            </td>
                                            <td data-label="Tr·∫°ng th√°i:">
                                                <span class="badge bg-info text-dark status-badge">{{ item.action }}</span>
                                            </td>
                                            <td data-label="Th·ªùi gian:" class="small text-muted">
                                                {{ item.timestamp }}
                                            </td>
                                            <td data-label="Thao t√°c:">
                                                <div class="d-grid gap-2 d-md-block">
                                                    <form action="/" method="POST" target="_blank" style="display:inline;">
                                                        <input type="hidden" name="search_code" value="{{ item.batch_code }}">
                                                        <button type="submit" class="btn btn-sm btn-outline-primary">
                                                            <i class="fas fa-eye"></i> Xem
                                                        </button>
                                                    </form>
                                                    
                                                    <a href="/generate_qr/{{ item.batch_code }}" target="_blank" class="btn btn-sm btn-outline-dark">
                                                        <i class="fas fa-qrcode"></i> QR
                                                    </a>
                                                </div>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    {% else %}
                                        <tr>
                                            <td colspan="5" class="text-center py-4 text-muted">
                                                Ch∆∞a c√≥ d·ªØ li·ªáu. H√£y t·∫°o m·ªõi!
                                            </td>
                                        </tr>
                                    {% endif %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // L·∫•y d·ªØ li·ªáu t·ª´ Python truy·ªÅn sang (Server-side rendering)
        // L∆∞u √Ω: D√πng filter | tojson ƒë·ªÉ bi·∫øn list Python th√†nh m·∫£ng Javascript an to√†n
        const labels = {{ chart_labels | tojson }};
        const data = {{ chart_data | tojson }};

        // N·∫øu ch∆∞a c√≥ d·ªØ li·ªáu th√¨ kh√¥ng v·∫Ω ƒë·ªÉ tr√°nh l·ªói
        if (labels.length > 0) {
            const ctx = document.getElementById('myChart').getContext('2d');
            new Chart(ctx, {
                type: 'doughnut', // Lo·∫°i bi·ªÉu ƒë·ªì: 'pie' (tr√≤n), 'bar' (c·ªôt), 'doughnut' (b√°nh donut)
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'S·ªë l∆∞·ª£ng l√¥ h√†ng',
                        data: data,
                        backgroundColor: [
                            '#198754', // Xanh l√° c√¢y
                            '#ffc107', // V√†ng
                            '#0d6efd', // Xanh d∆∞∆°ng
                            '#dc3545', // ƒê·ªè
                            '#6c757d'  // X√°m
                        ],
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false, // ƒê·ªÉ n√≥ t·ª± co gi√£n theo khung div b√™n ngo√†i
                    plugins: {
                        legend: {
                            position: 'right', // Ch√∫ th√≠ch n·∫±m b√™n ph·∫£i cho ƒë·∫πp
                        }
                    }
                }
            });
        } else {
            document.getElementById('myChart').parentNode.innerHTML = "<p class='text-muted text-center pt-5'>Ch∆∞a c√≥ d·ªØ li·ªáu ƒë·ªÉ v·∫Ω bi·ªÉu ƒë·ªì.</p>";
        }
        async function kiemTraHack() {
            // Hi·ªán loading cho chuy√™n nghi·ªáp
            Swal.fire({
                title: 'ƒêang qu√©t Blockchain...',
                html: 'H·ªá th·ªëng ƒëang t√≠nh to√°n l·∫°i to√†n b·ªô m√£ Hash.',
                timerProgressBar: true,
                didOpen: () => {
                    Swal.showLoading();
                }
            });

            const response = await fetch('/validate_chain');
            const data = await response.json();
            
            // T·∫Øt loading
            Swal.close();

            if (data.status == "An to√†n") {
                // Th√¥ng b√°o ƒë·∫πp m√†u xanh
                Swal.fire({
                    icon: 'success',
                    title: 'H·ªá th·ªëng An to√†n!',
                    text: 'T·∫•t c·∫£ d·ªØ li·ªáu ƒë·ªÅu to√†n v·∫πn v√† kh·ªõp v·ªõi ch·ªØ k√Ω s·ªë.',
                    confirmButtonColor: '#198754'
                });
            } else {
                // C·∫¢NH B√ÅO ƒê·ªé + N√öT KH√îI PH·ª§C
                Swal.fire({
                    icon: 'error',
                    title: 'PH√ÅT HI·ªÜN T·∫§N C√îNG!',
                    html: `
                        D·ªØ li·ªáu t·∫°i <b>Block #${data.error_block}</b> ƒë√£ b·ªã thay ƒë·ªïi tr√°i ph√©p!<br>
                        M√£ Hash kh√¥ng tr√πng kh·ªõp.
                    `,
                    showCancelButton: true,
                    confirmButtonText: 'üõ†Ô∏è Kh√¥i ph·ª•c ngay',
                    cancelButtonText: 'B·ªè qua',
                    confirmButtonColor: '#d33',
                    cancelButtonColor: '#6c757d'
                }).then((result) => {
                    // N·∫øu ng∆∞·ªùi d√πng b·∫•m n√∫t Kh√¥i ph·ª•c
                    if (result.isConfirmed) {
                        khoiPhucBlock(data.error_block);
                    }
                });
            }
        }

        // H√ÄM G·ªåI API KH√îI PH·ª§C
        async function khoiPhucBlock(index) {
            const response = await fetch('/recover_chain', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ block_index: index })
            });
            const result = await response.json();

            if (result.status == 'success') {
                Swal.fire(
                    'ƒê√£ kh√¥i ph·ª•c!',
                    'D·ªØ li·ªáu g·ªëc ƒë√£ ƒë∆∞·ª£c l·∫•y l·∫°i t·ª´ Node Backup.',
                    'success'
                ).then(() => {
                    location.reload(); // T·∫£i l·∫°i trang ƒë·ªÉ th·∫•y d·ªØ li·ªáu ƒë√∫ng
                });
            } else {
                Swal.fire('L·ªói', 'Kh√¥ng th·ªÉ kh√¥i ph·ª•c.', 'error');
            }
        }
    </script>
    </body>
</html>
</body>
</html>