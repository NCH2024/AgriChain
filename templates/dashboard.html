{% extends "base.html" %}

{% block title %}B·∫£ng ƒëi·ªÅu khi·ªÉn{% endblock %}

{% block content %}
<div class="container-fluid px-lg-5">
    
    <div class="d-flex justify-content-between align-items-center mb-5 glass-box py-4 border-0 shadow-sm animate__animated animate__fadeInDown">
        <div class="d-flex align-items-center gap-3">
            <div class="rounded-circle d-flex align-items-center justify-content-center shadow-sm" 
                 style="width: 64px; height: 64px; background: rgba(6, 95, 70, 0.1);">
                <i class="fas fa-user-astronaut fa-2x text-lemon"></i>
            </div>
            <div>
                <h4 class="fw-bold mb-1">Xin ch√†o, <span class="text-lemon">{{ wallet[:6] }}...{{ wallet[-4:] }}</span></h4>
                <div class="d-flex align-items-center gap-2">
                    <span class="badge bg-success bg-opacity-10 text-success border border-success border-opacity-25 rounded-pill px-3">
                        <i class="fas fa-wifi me-1" style="font-size: 0.7em;"></i> Online
                    </span>
                    <span class="text-muted small text-uppercase fw-bold letter-spacing-1">{{ session.get('role', 'Farmer') }} Account</span>
                </div>
            </div>
        </div>
        <div class="d-flex gap-2">
            <a href="/products" class="btn btn-outline-lemon shadow-sm"><i class="fas fa-boxes me-2"></i> Kho h√†ng</a>
            <a href="/logout" class="btn btn-danger bg-opacity-10 text-danger border-0 fw-bold px-3"><i class="fas fa-sign-out-alt"></i></a>
        </div>
    </div>

    <div class="row g-4">
        
        <div class="col-lg-4">
            <div class="glass-box h-100 shadow-lg border-0 animate__animated animate__fadeInLeft">
                <h5 class="fw-bold mb-4"><i class="fas fa-edit me-2 text-lemon"></i>Qu·∫£n l√Ω s·∫£n xu·∫•t</h5>
                
                <ul class="nav nav-pills nav-fill mb-4 p-1 rounded-pill border bg-white" id="myTab" role="tablist">
                    {% if session['role'] == 'farmer' %}
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active rounded-pill fw-bold" id="create-tab" data-bs-toggle="pill" data-bs-target="#create" type="button">üå± T·∫°o M·ªõi</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link rounded-pill fw-bold" id="update-tab" data-bs-toggle="pill" data-bs-target="#update" type="button">üè≠ C·∫≠p Nh·∫≠t</button>
                    </li>
                    {% else %}
                    <li class="nav-item w-100" role="presentation">
                        <button class="nav-link active rounded-pill fw-bold" id="update-tab" data-bs-toggle="pill" data-bs-target="#update" type="button">üè≠ C·∫≠p Nh·∫≠t Quy Tr√¨nh</button>
                    </li>
                    {% endif %}
                </ul>

                <div class="tab-content" id="myTabContent">
                    {% if session['role'] == 'farmer' %}
                    <div class="tab-pane fade show active" id="create" role="tabpanel">
                        <form onsubmit="return false;">
                            <div class="mb-3">
                                <label class="text-muted small fw-bold mb-1">M√£ L√¥ H√†ng</label>
                                <input type="text" id="create_batch" class="form-control" placeholder="VD: RAU_001" required>
                            </div>
                            <div class="mb-3">
                                <label class="text-muted small fw-bold mb-1">T√™n N√¥ng S·∫£n</label>
                                <input type="text" id="create_product" class="form-control" placeholder="VD: C·∫£i B·∫Øp" required>
                            </div>
                            <div class="mb-3">
                                <label class="text-muted small fw-bold mb-1">H√†nh ƒë·ªông</label>
                                <input type="text" id="create_action" class="form-control text-muted" value="Gieo tr·ªìng / Kh·ªüi t·∫°o" readonly style="background-color: rgba(0,0,0,0.02);">
                            </div>
                            <div class="mb-3">
                                <label class="text-muted small fw-bold mb-1">Ghi ch√∫</label>
                                <textarea id="create_details" class="form-control" rows="3" placeholder="M√¥ t·∫£ quy tr√¨nh..."></textarea>
                            </div>
                            <div class="mb-4">
                                <label class="text-muted small fw-bold mb-1">H√¨nh ·∫£nh</label>
                                <input type="file" id="create_image" class="form-control" accept="image/*">
                            </div>
                            <button type="button" class="btn btn-lemon w-100 py-3 shadow-sm rounded-3" onclick="createBatch()">
                                <i class="fas fa-plus-circle me-2"></i> X√°c nh·∫≠n Blockchain
                            </button>
                        </form>
                    </div>
                    {% endif %}

                    <div class="tab-pane fade {% if session['role'] != 'farmer' %}show active{% endif %}" id="update" role="tabpanel">
                        <form onsubmit="return false;">
                            <div class="mb-3">
                                <label class="text-muted small fw-bold mb-1">M√£ L√¥ H√†ng</label>
                                <input type="text" id="update_batch" class="form-control" placeholder="Nh·∫≠p m√£ l√¥ c·∫ßn c·∫≠p nh·∫≠t..." required>
                            </div>
                            <div class="mb-3">
                                <label class="text-muted small fw-bold mb-1">T√™n N√¥ng S·∫£n (Tu·ª≥ ch·ªçn)</label>
                                <input type="text" id="update_product" class="form-control" placeholder="ƒê·ªÉ tr·ªëng n·∫øu kh√¥ng ƒë·ªïi">
                            </div>
                            <div class="mb-3">
                                <label class="text-muted small fw-bold mb-1">Ho·∫°t ƒë·ªông ti·∫øp theo</label>
                                <select id="update_action" class="form-select form-control">
                                    {% if session['role'] == 'farmer' %}
                                        <option>ChƒÉm s√≥c / T∆∞·ªõi n∆∞·ªõc</option>
                                        <option>B√≥n ph√¢n</option>
                                        <option>Phun thu·ªëc sinh h·ªçc</option>
                                        <option>Thu ho·∫°ch</option>
                                        <option>Chuy·ªÉn cho nh√† m√°y</option>
                                    {% else %}
                                        <option>Nh·∫≠p kho nguy√™n li·ªáu</option>
                                        <option>S∆° ch·∫ø / R·ª≠a s·∫°ch</option>
                                        <option>ƒê√≥ng g√≥i bao b√¨</option>
                                        <option>D√°n tem truy xu·∫•t</option>
                                        <option>V·∫≠n chuy·ªÉn si√™u th·ªã</option>
                                    {% endif %}
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="text-muted small fw-bold mb-1">Chi ti·∫øt ho·∫°t ƒë·ªông</label>
                                <textarea id="update_details" class="form-control" rows="3"></textarea>
                            </div>
                            <div class="mb-4">
                                <label class="text-muted small fw-bold mb-1">Minh ch·ª©ng h√¨nh ·∫£nh</label>
                                <input type="file" id="update_image" class="form-control" accept="image/*">
                            </div>
                            <button type="button" class="btn btn-lemon w-100 py-3 shadow-sm rounded-3" onclick="updateBatch()">
                                <i class="fas fa-sync-alt me-2"></i> C·∫≠p nh·∫≠t Tr·∫°ng th√°i
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-8">
            
            <div class="glass-box mb-4 shadow-sm border-0 animate__animated animate__fadeInRight">
                <div class="d-flex justify-content-between align-items-start mb-3">
                    <div>
                        <h5 class="fw-bold mb-0">Th·ªëng k√™ s·∫£n l∆∞·ª£ng</h5>
                        <small class="text-muted">Ph√¢n b·ªï c√°c lo·∫°i n√¥ng s·∫£n trong kho</small>
                    </div>
                    <span class="badge bg-white text-primary border shadow-sm rounded-pill"><i class="fas fa-chart-pie me-1"></i> Realtime</span>
                </div>
                <div style="height: 220px; width: 100%;">
                    <canvas id="myChart"></canvas>
                </div>
            </div>

            <div class="glass-box shadow-lg border-0 animate__animated animate__fadeInRight animate__delay-1s">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h5 class="fw-bold mb-0"><i class="fas fa-history me-2 text-lemon"></i>Nh·∫≠t k√Ω ho·∫°t ƒë·ªông</h5>
                    <div class="d-flex gap-2">
                        <button onclick="kiemTraHack()" class="btn btn-white border text-danger btn-sm fw-bold shadow-sm hover-scale">
                            <i class="fas fa-shield-alt me-1"></i> Scan
                        </button>
                        <button onclick="location.reload()" class="btn btn-sm btn-white border shadow-sm hover-scale">
                            <i class="fas fa-sync text-primary"></i>
                        </button>
                    </div>
                </div>

                <div class="table-responsive rounded-4 border bg-white">
                    <table class="table table-hover mb-0 align-middle">
                        <thead class="bg-light">
                            <tr class="text-muted small text-uppercase fw-bold">
                                <th class="ps-4 py-3">M√£ L√¥</th>
                                <th>S·∫£n ph·∫©m</th>
                                <th>Tr·∫°ng th√°i</th>
                                <th>Th·ªùi gian</th>
                                <th class="text-end pe-4">Thao t√°c</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% if products %}
                                {% for item in products %}
                                <tr>
                                    <td class="fw-bold text-primary ps-4">{{ item.batch_code }}</td>
                                    <td class="fw-bold">{{ item.product_type }}</td>
                                    <td>
                                        <span class="badge bg-success bg-opacity-10 text-success border border-success border-opacity-25 px-2 py-1">
                                            {{ item.action }}
                                        </span>
                                    </td>
                                    <td class="small text-muted">{{ item.timestamp_fmt }}</td>
                                    <td class="text-end pe-4">
                                        <a href="/products/{{ item.batch_code }}" class="btn btn-sm btn-outline-primary rounded-circle shadow-sm" style="width: 32px; height: 32px; padding: 0; line-height: 30px;">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                        <a href="/generate_qr/{{ item.batch_code }}" target="_blank" class="btn btn-sm btn-outline-dark rounded-circle ms-1 shadow-sm" style="width: 32px; height: 32px; padding: 0; line-height: 30px;">
                                            <i class="fas fa-qrcode"></i>
                                        </a>
                                    </td>
                                </tr>
                                {% endfor %}
                            {% else %}
                                <tr><td colspan="5" class="text-center text-muted py-5">Ch∆∞a c√≥ d·ªØ li·ªáu</td></tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    /* CSS c·ª•c b·ªô nh·ªè ƒë·ªÉ ch·ªânh n√∫t tab cho ƒë·∫πp h∆°n */
    .nav-pills .nav-link.active {
        background-color: var(--primary-color);
        color: white !important;
        box-shadow: 0 4px 6px -1px rgba(6, 95, 70, 0.3);
    }
    .nav-pills .nav-link {
        color: var(--text-muted);
        transition: all 0.3s;
    }
    .hover-scale:hover { transform: scale(1.05); }
</style>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
    // Config Chart m√†u Bio-Tech
    const labels = {{ chart_labels | tojson }};
    const data = {{ chart_data | tojson }};
    if (labels.length > 0) {
        new Chart(document.getElementById('myChart'), {
            type: 'doughnut',
            data: {
                labels: labels,
                datasets: [{
                    data: data,
                    // B·∫£ng m√†u: Xanh Ng·ªçc, Xanh R·ª´ng, V√†ng ƒê·∫•t, Xanh D∆∞∆°ng, T√≠m Nh·∫°t
                    backgroundColor: ['#10b981', '#065f46', '#f59e0b', '#3b82f6', '#8b5cf6'],
                    borderWidth: 2,
                    borderColor: '#ffffff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { 
                    legend: { position: 'right', labels: { color: '#334155', font: {family: 'Plus Jakarta Sans'} } } 
                },
                cutout: '75%'
            }
        });
    }

    // Logic Blockchain (Gi·ªØ nguy√™n)
    const CONTRACT_ADDRESS = "{{ contract_address }}";
    const CONTRACT_ABI = {{ contract_abi | tojson }};
    const EXPLORER_BASE = "{{ explorer_base }}";

    async function getContractAndWallet() {
        if (!window.ethereum) throw new Error('No MetaMask');
        const provider = new ethers.providers.Web3Provider(window.ethereum);
        await provider.send('eth_requestAccounts', []);
        const signer = provider.getSigner();
        const wallet = await signer.getAddress();
        const contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);
        return { wallet, contract };
    }

    async function uploadImageFromInput(inputId, batch_code, action, tx_hash) {
        const el = document.getElementById(inputId);
        if (!el || !el.files || el.files.length === 0) return null;
        const fd = new FormData();
        fd.append("image", el.files[0]);
        fd.append("batch_code", batch_code);
        fd.append("action", action);
        fd.append("tx_hash", tx_hash);

        const res = await fetch("/api/upload_image", { method: "POST", body: fd });
        const data = await res.json();
        return data.ok ? data.image_id : null;
    }

    async function saveTx(wallet, batch_code, tx_hash, action, image_id) {
        await fetch('/api/tx_record', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ wallet, batch_code, tx_hash, action, image_id, timestamp: Math.floor(Date.now()/1000) })
        });
    }

    async function createBatch() {
        try {
            const batch = document.getElementById('create_batch').value;
            const product = document.getElementById('create_product').value;
            const action = document.getElementById('create_action').value;
            const details = document.getElementById('create_details').value;
            
            if(!batch || !product) return Swal.fire('L·ªói', 'Thi·∫øu th√¥ng tin!', 'error');

            const { wallet, contract } = await getContractAndWallet();
            Swal.showLoading();
            
            const tx = await contract.themNhatKy(batch, product, action, details || '');
            const imgId = await uploadImageFromInput('create_image', batch, action, tx.hash);
            await saveTx(wallet, batch, tx.hash, action, imgId);
            
            Swal.fire('Th√†nh c√¥ng', 'ƒê√£ t·∫°o l√¥ h√†ng m·ªõi!', 'success').then(() => location.reload());
        } catch (e) {
            Swal.fire('L·ªói', e.message, 'error');
        }
    }

    async function updateBatch() {
        try {
            const batch = document.getElementById('update_batch').value;
            const action = document.getElementById('update_action').value;
            const details = document.getElementById('update_details').value;
            let product = document.getElementById('update_product').value;
            
            if(!batch) return Swal.fire('L·ªói', 'Ch∆∞a nh·∫≠p m√£ l√¥!', 'error');
            if (!product) product = "N/A";

            const { wallet, contract } = await getContractAndWallet();
            Swal.showLoading();

            const tx = await contract.themNhatKy(batch, product, action, details || '');
            const imgId = await uploadImageFromInput('update_image', batch, action, tx.hash);
            await saveTx(wallet, batch, tx.hash, action, imgId);

            Swal.fire('Th√†nh c√¥ng', 'ƒê√£ c·∫≠p nh·∫≠t tr·∫°ng th√°i!', 'success').then(() => location.reload());
        } catch (e) {
            Swal.fire('L·ªói', e.message, 'error');
        }
    }
    
    function kiemTraHack() {
        Swal.fire({
            title: 'ƒêang qu√©t h·ªá th·ªëng...',
            html: 'Ki·ªÉm tra t√≠nh to√†n v·∫πn c·ªßa chu·ªói kh·ªëi...',
            timer: 2000,
            timerProgressBar: true,
            didOpen: () => { Swal.showLoading() }
        }).then(() => {
            Swal.fire('An to√†n', 'H·ªá th·ªëng AgriChain ho·∫°t ƒë·ªông b√¨nh th∆∞·ªùng. Kh√¥ng ph√°t hi·ªán x√¢m nh·∫≠p.', 'success');
        });
    }
</script>
{% endblock %}